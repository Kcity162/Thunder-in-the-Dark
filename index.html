<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thunder in the Dark â€” DM Wiki</title>
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('st-wiki-theme');
        const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (saved === 'dark' || (!saved && prefers)) document.documentElement.classList.add('dark');
      }catch(e){}
    })();
  </script>
  <!-- Tailwind via CDN for fast styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen bg-slate-200 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <!-- App Shell -->
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="sticky top-0 flex items-center justify-between gap-3 mb-4 px-1 py-2">
      <div class="w-full max-w-5xl">
        <div class="relative">
          <input id="search" type="search" placeholder="Search notes (âŒ˜/Ctrl + K)" class="w-full rounded-xl border px-4 py-3 pr-10 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500">âŒ˜K</span>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button data-filter="all" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">All</button>
          <button data-filter="session" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Sessions</button>
          <button data-filter="npc" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">NPCs</button>
          <button data-filter="location" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Locations</button>
          <button data-filter="rule" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Rules</button>
          <button data-filter="faction" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Factions</button>
          <button data-filter="tag:items" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Items</button>
          <button data-filter="tag:equipment" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Equipment</button>
          <button data-filter="tag:lore" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Lore</button>
          <button data-filter="tag:gods" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Gods</button>
          <button data-filter="tag:spells" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Spells</button>
          <button data-filter="tag:sounds" class="filter-btn px-3 py-1.5 rounded-full border bg-white text-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">Sounds</button>
        </div>
      </div>
      <nav class="flex items-center gap-2 text-sm relative">
        <div class="relative">
          <button id="btnMore" aria-haspopup="true" aria-expanded="false" title="More"
                  class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-100 dark:bg-slate-900 dark:border-slate-700 dark:hover:bg-slate-800">â‹¯</button>
          <div id="moreMenu" class="hidden absolute right-0 mt-2 w-44 card overflow-hidden">
            <button id="btnReload" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800">Reload</button>
            <button id="btnExport" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800">Export</button>
            <label class="w-full block text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer">
              Import <input id="fileImport" type="file" accept="application/json" class="hidden" />
            </label>
            <button id="btnPrint" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800">Print</button>
          </div>
        </div>
      </nav>
    </header>

    <!-- Controls -->
    <section class="grid md:grid-cols-3 gap-4 md:gap-6 items-start">
      <div class="md:col-span-1 space-y-3">
        <div id="quickNotesCard" class="card card-pad">
          <h2 class="font-semibold mb-2">Quick Notes</h2>
          <ul id="quickList" class="space-y-1 text-sm text-slate-700"></ul>
        </div>
        <div id="resultsCard" class="card hidden">
          <div class="flex items-center justify-between card-pad border-b border-slate-200 dark:border-slate-800">
            <div class="text-sm text-slate-600"><span id="resultCount">0</span> results</div>
            <div class="flex items-center gap-2 text-xs text-slate-500">
              <button id="btnClearSearch" class="px-2 py-1 rounded-md border bg-white hover:bg-slate-100 dark:bg-slate-900 dark:border-slate-700 dark:hover:bg-slate-800">Clear</button>
              <span class="kbd">Enter</span> open â€¢ <span class="kbd">â†‘â†“</span> move â€¢ <span class="kbd">Esc</span> clear
            </div>
          </div>
          <ul id="resultList" class="max-h-80 overflow-auto divide-y divide-slate-200 dark:divide-slate-800"></ul>
        </div>
      </div>

      <!-- Results + Reader -->
      <div class="md:col-span-2 grid gap-4">
        <article id="reader" class="card card-pad prose prose-slate max-w-none dark:prose-invert">
          <h2 class="m-0">Welcome ðŸ‘‹</h2>
          <p>Select a note, or press <span class="kbd">âŒ˜/Ctrl</span> + <span class="kbd">K</span> to search. This is your lightweight, single-file DM wiki for <em>Storm King's Thunder</em>.</p>
          <hr />
          <pre class="text-xs bg-slate-50 p-3 rounded-lg overflow-auto"><code>Repo idea
â”œâ”€â”€ index.html              # this file
â”œâ”€â”€ app.js                  # app logic
â”œâ”€â”€ styles.css              # custom styles
â”œâ”€â”€ /notes/ (optional)      # if you split notes later
â”‚   â”œâ”€â”€ sessions/
â”‚   â”œâ”€â”€ npcs/
â”‚   â”œâ”€â”€ locations/
â”‚   â”œâ”€â”€ rules/
â”‚   â””â”€â”€ factions/
â””â”€â”€ README.md</code></pre>
        </article>
      </div>
    </section>
  </div>

  <!-- Floating Action Button (New Note) -->
  <button id="btnNew" aria-label="New note" title="New note"
          class="fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg bg-indigo-600 text-white text-2xl leading-none
                 flex items-center justify-center hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300
                 dark:bg-indigo-500 dark:hover:bg-indigo-600 dark:focus:ring-indigo-800">
    +
  </button>

  <!-- External App Logic -->
  <script type="module" src="app.js"></script>
  <!-- Diagnostics (temporary) -->
  <div id="diag" class="fixed bottom-4 left-4 max-w-md hidden bg-white text-slate-900 border border-red-300 rounded-lg shadow p-3 text-sm z-50">
    <strong>JS Diagnostics</strong>
    <div id="diagBody" class="mt-2 whitespace-pre-wrap"></div>
    <button id="diagClose" class="mt-2 px-2 py-1 border rounded">Hide</button>
  </div>
  <script>
    // Show diagnostics panel with a message
    function showDiag(msg){
      try{
        const box = document.getElementById('diag');
        const body = document.getElementById('diagBody');
        body.textContent = (body.textContent ? body.textContent + "\n" : "") + String(msg);
        box.classList.remove('hidden');
        document.getElementById('diagClose').onclick = () => box.classList.add('hidden');
      }catch(_e){}
    }

    // Basic signal that inline JS is executing
    showDiag('Inline JS ran: '+ new Date().toLocaleTimeString());

    // Capture runtime errors
    window.addEventListener('error', (e)=>{
      showDiag('Error: ' + (e.message || e.error));
    });
    window.addEventListener('unhandledrejection', (e)=>{
      showDiag('Unhandled Promise Rejection: ' + (e.reason && (e.reason.message||e.reason)));
    });

    // Check that the module script was requested by the browser
    setTimeout(()=>{
      if(!window.__APP_BOOTED__){
        showDiag('app.js did not signal boot. Possible causes: 1) app.js missing/wrong path, 2) syntax error stopping execution, 3) fetch of JSON blocked (file://)');
      } else {
        showDiag('app.js signalled boot.');
      }
    }, 1500);

    // Optional quick JSON reachability check (safe even if the file does not exist)
    (async()=>{
      // Use cache: 'default' to ensure the file is fetched fresh on page load and refreshed on reload, allowing normal browser caching behavior.
      try{
        const r = await fetch('./st-wiki-notes.json', {cache:'default'});
        showDiag('JSON fetch status: ' + r.status);
      }catch(err){
        showDiag('JSON fetch failed (likely due to file:// or wrong path): ' + err);
      }
    })();
  </script>
</body>
</html>